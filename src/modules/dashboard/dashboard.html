<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Caller Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: #0f172a;
        color: #e2e8f0;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      h1 {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .subtitle {
        opacity: 0.9;
        font-size: 14px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #1e293b;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #94a3b8;
        font-size: 14px;
      }

      .calls-section {
        background: #1e293b;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
      }

      .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .refresh-btn:hover {
        background: #5a67d8;
        transform: translateY(-1px);
      }

      .calls-list {
        display: grid;
        gap: 15px;
      }

      .call-card {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.2s;
        cursor: pointer;
      }

      .call-card:hover {
        border-color: #667eea;
        transform: translateX(4px);
      }

      .call-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .call-info {
        flex: 1;
      }

      .call-name {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .call-phone {
        color: #94a3b8;
        font-size: 14px;
      }

      .call-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .badge-status {
        background: #1e40af;
        color: #bfdbfe;
      }

      .badge-state {
        background: #7c2d12;
        color: #fed7aa;
      }

      .badge-hot {
        background: #991b1b;
        color: #fecaca;
      }

      .badge-warm {
        background: #a16207;
        color: #fde68a;
      }

      .badge-cold {
        background: #1e3a8a;
        color: #bfdbfe;
      }

      .badge-not-interested {
        background: #334155;
        color: #cbd5e1;
      }

      .call-details {
        display: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #334155;
      }

      .call-card.expanded .call-details {
        display: block;
      }

      .detail-section {
        margin-bottom: 15px;
      }

      .detail-label {
        color: #94a3b8;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .transcript-item {
        background: #1e293b;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 14px;
        line-height: 1.6;
        border-left: 3px solid #475569;
      }

      .transcript-item.user {
        background: #1e3a5f;
        border-left-color: #3b82f6;
      }

      .transcript-item.bot {
        background: #1e2d3a;
        border-left-color: #10b981;
      }

      .transcript-role {
        font-size: 11px;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
        opacity: 0.7;
      }

      .transcript-time {
        font-size: 11px;
        color: #64748b;
        margin-left: 8px;
      }

      .key-point {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .key-point::before {
        content: "‚Ä¢";
        color: #667eea;
        font-weight: bold;
        margin-right: 8px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 15px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #64748b;
      }

      .spinner {
        border: 3px solid #334155;
        border-top-color: #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #94a3b8;
        font-size: 14px;
      }

      .auto-refresh input {
        cursor: pointer;
      }

      .quick-call-section {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid #475569;
      }

      .quick-call-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .call-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-label {
        font-size: 12px;
        color: #94a3b8;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .form-input {
        background: #0f172a;
        border: 1px solid #475569;
        border-radius: 6px;
        padding: 10px 12px;
        color: #e2e8f0;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-input::placeholder {
        color: #64748b;
      }

      .start-call-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .start-call-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .start-call-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .notification {
        padding: 12px 16px;
        border-radius: 6px;
        margin-top: 15px;
        font-size: 14px;
        display: none;
      }

      .notification.success {
        background: #064e3b;
        border: 1px solid #10b981;
        color: #6ee7b7;
        display: block;
      }

      .notification.error {
        background: #450a0a;
        border: 1px solid #dc2626;
        color: #fecaca;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ü§ñ AI Caller Dashboard</h1>
        <div class="subtitle">Real-time monitoring of outbound calls</div>
      </header>

      <div class="quick-call-section">
        <div class="quick-call-title">
          üìû Quick Start Call
        </div>
        <form id="quick-call-form" onsubmit="handleStartCall(event)">
          <div class="call-form">
            <div class="form-group">
              <label class="form-label" for="phone">Phone Number*</label>
              <input
                type="tel"
                id="phone"
                class="form-input"
                placeholder="+1234567890"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="firstName">First Name*</label>
              <input
                type="text"
                id="firstName"
                class="form-input"
                placeholder="John"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="lastName">Last Name*</label>
              <input
                type="text"
                id="lastName"
                class="form-input"
                placeholder="Doe"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="county">County*</label>
              <input
                type="text"
                id="county"
                class="form-input"
                placeholder="Orange County"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="state">State*</label>
              <input
                type="text"
                id="state"
                class="form-input"
                placeholder="CA"
                maxlength="2"
                required
              />
            </div>
          </div>
          <button type="submit" class="start-call-btn" id="start-call-btn">
            <span id="btn-text">üöÄ Start Call</span>
            <div class="spinner" id="btn-spinner" style="display: none; width: 20px; height: 20px; border-width: 2px;"></div>
          </button>
          <div id="notification" class="notification"></div>
        </form>
      </div>

      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="total-calls">-</div>
          <div class="stat-label">Total Calls</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="in-progress">-</div>
          <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completed">-</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="hot-leads">-</div>
          <div class="stat-label">Hot Leads</div>
        </div>
      </div>

      <div class="calls-section">
        <div class="section-header">
          <div>
            <div class="section-title">Recent Calls</div>
          </div>
          <div style="display: flex; gap: 15px; align-items: center">
            <div class="auto-refresh">
              <input type="checkbox" id="auto-refresh" checked />
              <label for="auto-refresh">Auto-refresh (25s)</label>
            </div>
            <button class="refresh-btn" onclick="loadCalls()">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <div id="calls-container">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading calls...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let autoRefreshInterval = null;

      // Load calls from API
      async function loadCalls() {
        try {
          const response = await fetch("/calls");
          const data = await response.json();

          updateStats(data.calls);
          renderCalls(data.calls);
        } catch (error) {
          console.error("Failed to load calls:", error);
          document.getElementById("calls-container").innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ùå</div>
            <div>Failed to load calls</div>
            <div style="font-size: 14px; margin-top: 10px;">${error.message}</div>
          </div>
        `;
        }
      }

      // Update statistics
      function updateStats(calls) {
        document.getElementById("total-calls").textContent = calls.length;

        const inProgress = calls.filter(
          (c) => c.status === "IN_PROGRESS" || c.status === "CALLING",
        ).length;
        document.getElementById("in-progress").textContent = inProgress;

        const completed = calls.filter((c) => c.status === "COMPLETED").length;
        document.getElementById("completed").textContent = completed;

        const hotLeads = calls.filter(
          (c) => c.summary?.interestLevel === "HOT",
        ).length;
        document.getElementById("hot-leads").textContent = hotLeads;
      }

      // Render calls list
      function renderCalls(calls) {
        const container = document.getElementById("calls-container");

        if (calls.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìû</div>
            <div>No calls yet</div>
            <div style="font-size: 14px; margin-top: 10px;">Start a call to see it here</div>
          </div>
        `;
          return;
        }

        // Sort by most recent
        calls.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        container.innerHTML = `
        <div class="calls-list">
          ${calls.map((call) => renderCallCard(call)).join("")}
        </div>
      `;
      }

      // Render single call card
      function renderCallCard(call) {
        const leadName = call.leadData
          ? `${call.leadData.firstName} ${call.leadData.lastName}`
          : "Unknown";

        const phone = call.phone || "N/A";

        const interestBadge = call.summary?.interestLevel
          ? `<span class="badge badge-${call.summary.interestLevel.toLowerCase().replace("_", "-")}">${call.summary.interestLevel}</span>`
          : "";

        return `
        <div class="call-card" onclick="toggleCallDetails('${call.id}')">
          <div class="call-header">
            <div class="call-info">
              <div class="call-name">${leadName}</div>
              <div class="call-phone">${phone}</div>
            </div>
            <div class="call-badges">
              <span class="badge badge-status">${call.status}</span>
              <span class="badge badge-state">${call.state}</span>
              ${interestBadge}
            </div>
          </div>

          <div class="call-details" id="details-${call.id}">
            ${renderCallDetails(call)}
          </div>
        </div>
      `;
      }

      // Render call details
      function renderCallDetails(call) {
        let html = "";

        // Error message (for FAILED calls)
        if (call.status === "FAILED" && call.errorMessage) {
          html += `
          <div class="detail-section">
            <div class="detail-label" style="color: #f87171;">‚ö†Ô∏è Error</div>
            <div style="background: #450a0a; border-left: 3px solid #dc2626; padding: 12px; border-radius: 6px; color: #fecaca; font-size: 14px;">
              ${call.errorMessage}
            </div>
          </div>
        `;
        }

        // Transcript
        if (call.transcript && call.transcript.length > 0) {
          html += `
          <div class="detail-section">
            <div class="detail-label">Transcript (${call.transcript.length} messages)</div>
            ${call.transcript
              .map((msg, i) => {
                // Handle both old format (string) and new format (object)
                const isOldFormat = typeof msg === 'string';
                const role = isOldFormat ? 'user' : msg.role;
                const message = isOldFormat ? msg : msg.message;
                const time = isOldFormat ? null : msg.secondsFromStart;

                const roleLabel = role === 'bot' ? 'ü§ñ Assistant' : 'üë§ User';
                const roleClass = role === 'bot' ? 'bot' : 'user';
                const timeDisplay = time ? `<span class="transcript-time">+${Math.floor(time)}s</span>` : '';

                return `
                  <div class="transcript-item ${roleClass}">
                    <div class="transcript-role">${roleLabel}${timeDisplay}</div>
                    <div>${message}</div>
                  </div>
                `;
              })
              .join("")}
          </div>
        `;
        }

        // Summary
        if (call.summary) {
          html += `
          <div class="detail-section">
            <div class="detail-label">Summary</div>
            <div style="margin-bottom: 10px;">
              <strong>Duration:</strong> ${Math.floor(call.summary.duration / 60)}m ${call.summary.duration % 60}s
            </div>
            <div style="margin-bottom: 10px;">
              <strong>Outcome:</strong> ${call.summary.outcome}
            </div>
            <div style="margin-bottom: 10px;">
              <strong>Next Action:</strong> ${call.summary.nextAction || "None"}
            </div>
          </div>
        `;

          if (call.summary.keyPoints && call.summary.keyPoints.length > 0) {
            html += `
            <div class="detail-section">
              <div class="detail-label">Key Points</div>
              ${call.summary.keyPoints
                .map(
                  (point) => `
                <div class="key-point">${point}</div>
              `,
                )
                .join("")}
            </div>
          `;
          }
        }

        // Timestamps
        html += `
        <div class="detail-section">
          <div class="detail-label">Timeline</div>
          <div style="font-size: 13px; color: #94a3b8;">
            <div>Created: ${new Date(call.createdAt).toLocaleString()}</div>
            ${call.startedAt ? `<div>Started: ${new Date(call.startedAt).toLocaleString()}</div>` : ""}
            ${call.completedAt ? `<div>Completed: ${new Date(call.completedAt).toLocaleString()}</div>` : ""}
          </div>
        </div>
      `;

        return (
          html || '<div style="color: #64748b;">No details available</div>'
        );
      }

      // Toggle call details
      function toggleCallDetails(callId) {
        const card = event.currentTarget;
        card.classList.toggle("expanded");
      }

      // Handle start call form submission
      async function handleStartCall(event) {
        event.preventDefault();

        const btn = document.getElementById("start-call-btn");
        const btnText = document.getElementById("btn-text");
        const btnSpinner = document.getElementById("btn-spinner");
        const notification = document.getElementById("notification");

        // Get form values
        let phone = document.getElementById("phone").value.trim();
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const county = document.getElementById("county").value.trim();
        const state = document.getElementById("state").value.trim().toUpperCase();

        // Basic validation
        if (!phone || !firstName || !lastName || !county || !state) {
          showNotification("Please fill in all required fields", "error");
          return;
        }

        if (state.length !== 2) {
          showNotification("State must be 2 characters (e.g., CA)", "error");
          return;
        }

        // Auto-add + to phone number if missing (E.164 format)
        if (!phone.startsWith("+")) {
          phone = "+" + phone;
          console.log("Auto-added + to phone number:", phone);
        }

        // Show loading state
        btn.disabled = true;
        btnText.style.display = "none";
        btnSpinner.style.display = "block";
        notification.style.display = "none";

        try {
          const response = await fetch("/calls/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              firstName,
              lastName,
              phone,
              county,
              state,
              acreage: 5.0,              // Default value to match test-e2e
              propertyAddress: "Property in " + county,  // Default value
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Failed to start call");
          }

          // Success
          showNotification(
            `‚úÖ Call started successfully! Call ID: ${data.callId}`,
            "success"
          );

          // Clear form
          document.getElementById("quick-call-form").reset();

          // Reload calls to show the new call
          setTimeout(() => {
            loadCalls();
          }, 1000);
        } catch (error) {
          console.error("Failed to start call:", error);
          showNotification(`‚ùå ${error.message}`, "error");
        } finally {
          // Reset button state
          btn.disabled = false;
          btnText.style.display = "inline";
          btnSpinner.style.display = "none";
        }
      }

      // Show notification
      function showNotification(message, type) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = "block";

        // Auto-hide after 5 seconds
        setTimeout(() => {
          notification.style.display = "none";
        }, 5000);
      }

      // Auto-refresh toggle
      document
        .getElementById("auto-refresh")
        .addEventListener("change", function () {
          if (this.checked) {
            autoRefreshInterval = setInterval(loadCalls, 25000);
          } else {
            if (autoRefreshInterval) {
              clearInterval(autoRefreshInterval);
              autoRefreshInterval = null;
            }
          }
        });

      // Initial load
      loadCalls();

      // Start auto-refresh
      autoRefreshInterval = setInterval(loadCalls, 25000);
    </script>
  </body>
</html>
